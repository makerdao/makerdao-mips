FROM node:16.16.0-alpine3.16 as appbuild

WORKDIR /usr/src/backend

ARG NODE_ENV
ARG MONGODB_URI
ARG PORT
ARG FOLDER_REPOSITORY_NAME
ARG REPO_PATH
ARG FOLDER_PATTERN
ARG WEBHOOKS_SECRET_TOKEN
ARG GIT_ACCESS_API_TOKEN
ARG REQUEST_GITHUB_URL_API_ENDPOINT
ARG MIP_GITHUB_REPOSITORY
ARG MIP_GITHUB_REPOSITORY_OWNER
ARG GITHUB_LINKS

ENV NODE_ENV=${NODE_ENV:-"development"}
ARG MONGODB_URI=${MONGODB_URI}
ARG PORT=${PORT:-3000}

ARG FOLDER_REPOSITORY_NAME=${FOLDER_REPOSITORY_NAME}
ARG REPO_PATH=${REPO_PATH:-"https://github.com/makerdao/mips.git"}
ARG FOLDER_PATTERN=${FOLDER_PATTERN:-"MIP*"}

ARG WEBHOOKS_SECRET_TOKEN=${WEBHOOKS_SECRET_TOKEN}
ARG GIT_ACCESS_API_TOKEN=${GIT_ACCESS_API_TOKEN}
ARG REQUEST_GITHUB_URL_API_ENDPOINT=${REQUEST_GITHUB_URL_API_ENDPOINT:-"https://api.github.com/graphql"}
ARG MIP_GITHUB_REPOSITORY=${MIP_GITHUB_REPOSITORY}
ARG MIP_GITHUB_REPOSITORY_OWNER=${MIP_GITHUB_REPOSITORY_OWNER}

COPY ./package*.json ./
RUN npm install

COPY . .
RUN npm run build

FROM node:16.16.0-alpine3.16

WORKDIR /usr/src/backend

COPY --from=appbuild /usr/src/backend/package*.json ./
RUN npm install --production
COPY --from=appbuild /usr/src/backend/dist ./dist

EXPOSE 3000

CMD yarn run start:prod
